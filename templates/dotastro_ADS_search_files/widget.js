function _typeof(t){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(t,e,r){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var i,o,n,a,s=[],c=!0,u=!1;try{if(n=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(i=n.call(r)).done)&&(s.push(i.value),s.length!==e);c=!0);}catch(t){u=!0,o=t}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(u)throw o}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}define(["js/widgets/base/base_widget","js/components/api_query","js/components/api_query_updater","hbs!js/widgets/classic_form/form","js/widgets/paper_search_form/topterms","analytics","js/widgets/sort/widget.jsx","js/widgets/sort/redux/modules/sort-app"],function(t,e,r,i,o,n,a,s){var c={AND:" ",OR:" OR ",BOOLEAN:" "},u=Backbone.Model.extend({initialize:function(){this.listenTo(this,"change",_.bind(this.serialize,this)),this.updater=new r(" "),this.serialize()},defaults:{"author-logic":"AND","object-logic":"AND","title-logic":"AND","abstract-logic":"AND","author-names":[],"object-names":[],collections:{astronomy:!0,physics:!1,general:!1},property:{refereed:!1,article:!1},pubdate:{month_from:"01",year_from:"0000",month_to:"12",year_to:"9999"},title:"",abs:"",bibstem:"",query:null,sort:"date desc"},_makeFqStr:function(t,e){var r=_.keys(t),i=_(t).pick(_.identity).keys().value();return i.length>1?e&&r.length===i.length?"("+i.join(" AND ")+")":"("+i.join(" OR ")+")":i[0]},_movePrefix:function(t){var e=this.updater;return _.map(t,function(t){var r="";return/^[=\-+]/.test(t)&&(r=t.substr(0,1),t=t.substr(1)),r+e.quoteIfNecessary(t)})},serialize:_.debounce(function(){var t,e=this.updater,r=this.toJSON(),i={q:[],fq:[],sort:r.sort};(t=this._makeFqStr(r.collections))&&(i.__fq_database=["AND",t],i.fq.push("{!type=aqp v=$fq_database}"),i.fq_database="database: "+t),(t=this._makeFqStr(r.property,!0))&&(i.__fq_property=["AND",t],i.fq.push("{!type=aqp v=$fq_property}"),i.fq_property="property: "+t);var o=r.pubdate,n=["[",o.year_from,"-",o.month_from," TO ",o.year_to,"-",o.month_to,"]"].join("");_.isEqual(o,this.defaults.pubdate)||i.q.push("pubdate:"+n);var a=c[r["author-logic"]],s=!1,u=_.map(r["author-names"],function(t){var e="";return/^[=\-+]/.test(t)&&(e=t.substr(0,1),t=t.substr(1)),/[\$]$/.test(t)&&(s=!0,t=t.substr(0,t.length-1)),e+'"'+t+'"'}),l="author:("+u.join(a)+")";s&&(l+=" author_count:1"),u.length&&i.q.push(l);var p=c[r["object-logic"]],h=this._movePrefix(r["object-names"]);l="object:("+h.join(p)+")";h.length&&i.q.push(l);var d=c[r["title-logic"]],f=r.title.split(/\s+/);f.length>0&&""!==f[0]&&i.q.push("title:("+f.join(d)+")");var m=c[r["abstract-logic"]],b=r.abs.split(/\s+/);l="abs:("+b.join(m)+")";b.length&&""!==b[0]&&i.q.push(l);var y=_.reduce(r.bibstem.match(/[^,^\s]+/g),function(t,r){return/^\-/.test(r)?t.neg.push(e.quoteIfNecessary(r.replace(/^\-/,""))):t.pos.push(e.quoteIfNecessary(r)),t},{neg:[],pos:[]});y.neg.length&&i.q.push("-bibstem:("+y.neg.join(" OR ")+")"),y.pos.length&&i.q.push("bibstem:("+y.pos.join(" OR ")+")"),_.isEmpty(i.q)&&i.q.push("*"),this.set("query",_.reduce(i,function(t,e,r){return _.isEmpty(e)?t:(t[r]=_.isArray(e)?e:[e],t)},{}))},50)}),l=Marionette.ItemView.extend({initialize:function(){var t=this;this.sortWidget=new a,this.sortWidget.onSortChange=_.bind(this.onSortChange,this),this.model.on("change:sort",function(){var e=_slicedToArray(t.model.get("sort").split(" "),2),r=e[0],i=e[1],o=t.sortWidget.store.getState(),n=o.sort,a=o.direction;r===n.id&&i===a||(t.sortWidget.store.dispatch(s.setQuery(null)),t.sortWidget.store.dispatch(s.setSort(r,!0)),t.sortWidget.store.dispatch(s.setDirection(i,!0)))})},template:i,className:"classic-form",events:{"submit form":"submitForm","reset form":"onReset",'change input[name$="-logic"]':"updateLogic","input textarea":"textareaUpdate",'change div[data-field="database"] input':"updateCollection",'change div[data-field="property"] input':"updateProperty",'input input[name="title"],input[name="abs"],input[name="bibstem"]':"inputUpdate",'input input[name^="month"],input[name^="year"]':"dateUpdate"},onChangeToCollections:function(t){var e=this;Object.keys(t).forEach(function(r){var i=$("div[data-field=database] input[name=".concat(r,"]"),e.$el);i.length>0&&i.prop("checked",t[r])})},onChangeToProperty:function(t){var e=this;Object.keys(t).forEach(function(r){var i=$("div[data-field=property] input[name=".concat(r,"]"),e.$el);i.length>0&&i.prop("checked",t[r])})},updateLogic:function(t){var e=this.$(t.currentTarget);this.model.set(e.attr("name"),e.val().trim())},onSortChange:function(){var t=this.sortWidget.store.getState(),e=t.sort,r=t.direction,i=e.id+" "+r;this.model.set("sort",i)},textareaUpdate:function(t){var e=this.$(t.currentTarget),r=_.filter(e.val().split(/[\n;]\s*/),function(t){return!_.isEmpty(t)});r=r.map(Function.prototype.call,String.prototype.trim),this.model.set(e.attr("name"),r)},updateCollection:function(t){var e=this.$(t.currentTarget),r={};r[e.attr("name")]=e.prop("checked"),this.model.set("collections",_.extend({},this.model.get("collections"),r))},updateProperty:function(t){var e=this.$(t.currentTarget),r={};r[e.attr("name")]=e.prop("checked"),this.model.set("property",_.extend({},this.model.get("property"),r))},inputUpdate:function(t){var e=this.$(t.currentTarget);this.model.set(e.attr("name"),e.val().trim())},dateUpdate:function(t){var e=this.$(t.currentTarget),r=e.attr("name"),i=e.val().trim(),o={};i=""===i?this.model.defaults.pubdate[r]:i,o[r]=i,this.model.set("pubdate",_.extend({},this.model.get("pubdate"),o))},submitForm:function(t){return t.preventDefault(),this.trigger("submit",this.model.get("query")),this.$("button[type=submit]").each(function(){var t=$(this),e=t.html();t.html('<i class="icon-loading" aria-hidden="true"/>  Loading...'),setTimeout(function(){t.html(e)},3e3)}),!1},onReset:function(){this.model.set(this.model.defaults),this.render()},onRender:function(){var t=this;this.$("#sort-container").html(this.sortWidget.render().el);var e=function(t){return _.last(t.split(/(,\s|;\s|[,;])/)).replace(/^\-/,"")},r=this.$("input[name=bibstem]");r.data("ui-autocomplete")||(r.autocomplete({minLength:1,autoFocus:!0,source:function(t,r){return r($.map(o,function(r){if(_.isString(t.term)){var i=e(t.term).toUpperCase(),o=r.value.toUpperCase(),n=r.label.toUpperCase();if(0===o.indexOf(i)||0===n.indexOf(i)||0===n.replace(/^THE\s/,"").indexOf(i))return r}}))},focus:function(){return!1},select:function(e,r){var i=this.value.split(/,\s*/),o=i.pop();return i.push((o.startsWith("-")?"-":"")+r.item.value),i.push(""),this.value=i.join(", "),t.model.set("bibstem",this.value),e.preventDefault(),!1}}).data("ui-autocomplete")._renderItem=function(t,r){var i=e(this.term).toUpperCase().trim(),o=new RegExp("("+i+")","i"),n=r.label;i.length>0&&(n=n.replace(o,'<span class="ui-state-highlight">$1</span>'));var a=$("<li/>").appendTo(t);return $("<a/>").attr("href","javascript:void(0)").html(n).appendTo(a).on("click",function(t){t.preventDefault()}),a})}});return t.extend({initialize:function(t){t=t||{},this.model=new u,this.view=new l({model:this.model}),this.listenTo(this.view,"submit",this.submitForm)},activate:function(t){var e=this;this.setBeeHive(t),this.view.sortWidget.activate(t);var r=this.getPubSub(),i=this;r.subscribe(r.CUSTOM_EVENT,function(t){"start-new-search"===t&&i.onNewSearch()}),r.subscribe(r.USER_ANNOUNCEMENT,function(t,r){if("user_info_change"===t&&r.defaultDatabase&&JSON.stringify(e.model.get("collections"))===JSON.stringify(e.model.defaults.collections)){var i=e.getDbSelectionFromUserData();e.model.set("collections",i||e.model.defaults.collections),e.view.triggerMethod("changeToCollections",i||e.model.defaults.collections)}})},applyQueryParams:function(t){var e=this;if(t){var r=t.toJSON();Object.keys(r).forEach(function(t){t.match(/^(c|collection)$/i)?function(t){if(t){var r=function(t){return t.match(/^(a|astronomy)$/i)?{astronomy:!0}:t.match(/^(p|physics)$/i)?{physics:!0}:t.match(/^(g|general)$/i)?{general:!0}:void 0},i={astronomy:!1,physics:!1,general:!1},o={};o=t.includes(",")?t.split(",").splice(0,3).reduce(function(t,e){return _objectSpread(_objectSpread({},t),r(e))},i):_objectSpread(_objectSpread({},i),r(t)),e.model.set("collections",o),e.view.triggerMethod("changeToCollections",o)}}(r[t][0]):t.match(/^(p|property)$/i)&&function(t){if(t){var r=function(t){return t.match(/^(r|refereed)$/i)?{refereed:!0}:t.match(/^(a|article)$/i)?{article:!0}:void 0},i={refereed:!1,article:!1},o={};o=t.includes(",")?t.split(",").splice(0,3).reduce(function(t,e){return _objectSpread(_objectSpread({},t),r(e))},i):_objectSpread(_objectSpread({},i),r(t)),e.model.set("property",o),e.view.triggerMethod("changeToProperty",o)}}(r[t][0])})}},onNewSearch:function(){this.model.set(this.model.defaults),this.view.triggerMethod("reset")},setFocus:function(t){var e=_.bind(this.view.$,this.view);!function r(i){var o=e(t);if(o.is(":visible")||i<=0)return o.focus();setTimeout(r,100,--i)}(10)},onShow:function(){if(this.view.$("button[type=submit]").each(function(){$(this).html('<i class="fa fa-search" aria-hidden="true"></i> Search')}),this.setFocus("#classic-author"),JSON.stringify(this.model.get("collections"))===JSON.stringify(this.model.defaults.collections)){var t=this.getDbSelectionFromUserData();this.model.set("collections",t||this.model.defaults.collections),this.view.triggerMethod("changeToCollections",t||this.model.defaults.collections)}},getDbSelectionFromUserData:function(){try{var t=this.getBeeHive().getObject("User").getUserData(),e=!1,r=t.defaultDatabase.reduce(function(t,r){return r.value&&(e=!0),t[r.name.toLowerCase()]=r.value,t},{});return e?r:null}catch(t){return null}},submitForm:function(t){var r=_.assign({},t,{q:t.q.join(" ")});r=new e(r);var i=this.getPubSub(),o={q:r,context:{referrer:"ClassicSearchForm"}};i.publish(i.NAVIGATE,"search-page",o),n("send","event","interaction","classic-form-submit",JSON.stringify(t))},dontKillMe:!0})});