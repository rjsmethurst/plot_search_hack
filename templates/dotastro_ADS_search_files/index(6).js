function _typeof(e){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}define(["underscore","../models/authorAffiliation","../constants/actionNames","filesaver"],function(e,t,r){var n=function(e,t,r){return[].concat(_toConsumableArray(e.slice(0,t)),[r],_toConsumableArray(e.slice(t+1)))},o=e.memoize(function(e){return e.map(function(e,t){return _objectSpread(_objectSpread({},e),{},{selected:!0,affiliations:e.affiliations.map(function(e,t){return _objectSpread(_objectSpread({},e),{},{selected:0===t})}),lastActiveDates:e.lastActiveDates.map(function(e,t){return _objectSpread(_objectSpread({},e),{},{selected:0===t})})})})},function(){return 0}),a=e.memoize(function(e,t){return e.map(function(e){return _objectSpread(_objectSpread({},e),{},{selected:t,affiliations:e.affiliations.map(function(e){return _objectSpread(_objectSpread({},e),{},{selected:t})}),lastActiveDates:e.lastActiveDates.map(function(e,r){return _objectSpread(_objectSpread({},e),{},{selected:t&&0===r})})})})},function(e,t){return t}),i={appReset:function(){return function(e){return e({type:r.appReset})}},reset:function(){return function(e,t){var n=t().data;e({type:r.setData,value:o(n)})}},toggleAll:function(){return function(e,t){var n=t(),o=n.data,i=n.toggle;e({type:r.setData,value:a(o,i)}),e({type:r.setToggle})}},setAffiliationData:function(n){return function(o){n=e(n).groupBy("authorName").map(function(e,r){return t.create(r,e)}).value(),o({type:r.setData,value:n})}},closeWidget:function(){return function(e,t,r){r.closeWidget()}},showMessage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"success",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;return function(a,i){0!==o&&e.delay(function(){a({type:r.setMessage,value:{show:!1}}),a({type:r.setShowReload,value:!1})},o),i().exporting||a({type:r.setShowReload,value:"danger"===t}),a({type:r.setMessage,value:{type:t,message:n,show:!0}})}},_reload:e.debounce(function(e,t){var r=e().ids;t.fetchAffiliationData(r)},500),reload:function(){return function(e,t,r){i._reload(t,r)}},updateYear:function(e){return function(t,n,o){var a=n();try{e=Number(e)}catch(t){e=a.year}t({type:r.setYear,value:e}),o.fetchAffiliationData(a.ids,e,a.author)}},updateAuthor:function(e){return function(t,n,o){var a=n();try{e=Number(e)}catch(t){e=a.author}t({type:r.setAuthor,value:e}),o.fetchAffiliationData(a.ids,a.year,e)}}};return i.toggleSelection=function(t,o){return function(a,i){var c=i().data,u=-1,s=-1,l=[],f=e.indexOf(c,t);o&&(u=e.indexOf(t.affiliations,o),s=e.indexOf(t.lastActiveDates,o)),l=u>=0?function(t,r,o,a,i){var c=n(t[o].affiliations,r,_objectSpread(_objectSpread({},i),{},{selected:!i.selected})),u=e.any(c,{selected:!0})||e.any(t[o].lastActiveDates,{selected:!0});return n(t,o,_objectSpread(_objectSpread({},a),{},{selected:u,affiliations:c}))}(c,u,f,t,o):s>=0?function(t,r,o,a,i){var c=e.findIndex(t[r].lastActiveDates,{selected:!0}),u=n(t[r].lastActiveDates,o,_objectSpread(_objectSpread({},a),{},{selected:!a.selected}));c>=0&&(u=n(u,c,_objectSpread(_objectSpread({},u[c]),{},{selected:!1})));var s=e.any(u,{selected:!0})||e.any(t[r].affiliations,{selected:!0});return n(t,r,_objectSpread(_objectSpread({},i),{},{selected:s,lastActiveDates:u}))}(c,f,s,o,t):f>=0?function(e,t,r){return n(e,t,_objectSpread(_objectSpread({},r),{},{selected:!r.selected,affiliations:r.selected?e[t].affiliations.map(function(e){return _objectSpread(_objectSpread({},e),{},{selected:!1})}):e[t].affiliations,lastActiveDates:r.selected?e[t].lastActiveDates.map(function(e){return _objectSpread(_objectSpread({},e),{},{selected:!1})}):e[t].lastActiveDates}))}(c,f,t):c,a({type:r.setData,value:l})}},i.doExport=function(){return function(t,n,o){var a,c,u=n(),s=u.data,l=u.format,f=function(e){switch(/\[(.*)]/.exec(e)[1]){case"csv":return{ext:"csv",type:"text/csv"};case"excel":return{ext:"xls",type:"application/vnd.ms-excel"};case"browser":return{ext:"browser",type:"text/plain"};default:return{ext:"txt",type:"text/plain"}}}(l);t({type:r.setExporting,value:!0}),o.exportAffiliationData({selected:(a=s,c=[],e.forEach(a,function(t){var r=[];if(t.selected){var n=e.find(t.lastActiveDates,{selected:!0});n=n?n.date:" ";var o=e.filter(t.affiliations,{selected:!0});e.isEmpty(o)&&c.push([t.author," ",n].join("|")),e.forEach(o,function(e){e.selected&&(r.push(t.author),r.push(e.name),r.push(n),c.push(r.join("|")))})}}),c),format:l}).done(function(e){"browser"===f.ext?(e.text().then(function(e){return t=e,(r=window.open()).document.write(t),void r.focus();var t,r}),t(i.showMessage("info","If new tab doesn't appear, you will need to allow popups"))):(e.blob().then(function(e){return saveAs(e,"authorAffiliations.".concat(f.ext))}),t(i.showMessage("success","Export Successful!")))}).fail(function(){i.showMessage("danger","Something happened with the request, please try again")}).always(function(){return t({type:r.setExporting,value:!1})}),i.showMessage("info","Exporting...")}},i});