define(["underscore","jquery","js/widgets/base/base_widget","js/components/api_query","js/components/api_request","js/components/api_targets","hbs!js/widgets/paper_search_form/form","./topterms"],function(e,t,r,i,n,s,o,a){var c=function(e,r){var i=new RegExp("("+this.term+")","i"),n=r.label.replace(i,'<span class="ui-state-highlight">$1</span>'),s=t("<li/>").appendTo(e);return t("<a/>").html(n).appendTo(s),s},u=function(r,i){return i(t.map(a,function(t){if(e.isString(r.term)){var i=r.term.toUpperCase(),n=t.value.toUpperCase(),s=t.label.toUpperCase();if(0===n.indexOf(i)||0===s.indexOf(i)||0===s.replace(/^THE\s/,"").indexOf(i))return t}}))},d=Marionette.ItemView.extend({template:o,className:"paper-search-form",onRender:function(){var e,r,i=this;e=this.el,(r=t("input#bibstem",e)).data("ui-autocomplete")||(r.on("keyup",function(e){13===e.keyCode&&r.trigger("enter")}),r.autocomplete({minLength:1,autoFocus:!0,source:u}),r.data("ui-autocomplete")._renderItem=c),setTimeout(function(){t("input",i.el).get(0).focus()},100)},events:{"submit form":"submit"},_submit:e.debounce(function(e){var r=t(e.target).addClass("submitted").data("formType"),i=t("input, textarea",e.target).toArray().reduce(function(e,t){return e[t.name]=t.value,e},{});this.setFormDisabled(!0),t('button[type="submit"]',e.target).html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> Submitting...'),this.trigger("submit",r,i)},1e3,{leading:!0,trailing:!1}),submit:function(e){e.preventDefault(),this._submit(e)},setFormDisabled:function(e){t("input, textarea, button",this.el).prop("disabled",e).toggleClass("disabled",e),t('button[type="submit"]',this.el).html('\n        <i class="fa fa-search" aria-hidden="true"></i> Search\n      ')},onDone:function(){this.setFormDisabled(!1)},onFail:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Error",r=t(this.el),i=t("form.submitted",r).closest(".row");t(".error-container",i).html('\n      <div class="alert alert-danger" id="error-message">\n        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>  <strong>Error: '.concat(e,"</strong>\n      </div>\n    ")),this.setFormDisabled(!1),t("input, textarea, button",r).one("focus",function(){t("#error-message",r).remove(),t("form.submitted",r).removeClass("submitted")})},onReset:function(){this.render()},onShow:function(){this.setFormDisabled(!1),t("input",this.el).get(0).focus()}});return r.extend({initialize:function(){this.view=new d,this.view.on("submit",this.onSubmit.bind(this))},activate:function(e){var t=this;r.prototype.activate.call(this,e);var i=this.getPubSub();i.subscribe(i.CUSTOM_EVENT,function(e,r){"start-new-search"===e?t.onNewSearch():"second-order-search/error"===e&&t.view.triggerMethod("fail",r.message)})},onNewSearch:function(){this.view.triggerMethod("reset")},processResponse:function(){},onSubmit:function(e,t){var r=this;switch(e){case"reference":this.sendReferenceQuery(t).done(function(e){var t,i,n,s=e.resolved,o=(i=(t=s).score,n=t.bibcode,"0.0"!==i&&n?n:null);if(o)return r.doSearch("bibcode:".concat(o));r.view.triggerMethod("fail","No bibcodes matching reference string")}).fail(function(e){if(e.responseJSON&&e.responseJSON.error)return r.view.triggerMethod("fail",e.responseJSON.error);r.view.triggerMethod("fail","Error occurred sending reference request")});break;case"journal":try{var i=Object.keys(t).filter(function(e){return t[e].trim()}).map(function(e){return"".concat(e,":").concat(t[e])}).join(" ");this.doSearch(i)}catch(e){this.view.triggerMethod("fail","Error parsing journals")}break;case"bibcodes":try{var n=t.bibcodes.split(/\s+/).filter(function(e){return!!e});if(0===n.length)return this.view.triggerMethod("done");this.doBigSearch(n)}catch(e){this.view.triggerMethod("fail","Error parsing bibcodes")}}},doBigSearch:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.getPubSub();t.publish(t.CUSTOM_EVENT,"second-order-search/limit",{ids:e})},doSearch:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new i({q:e,sort:["date desc"]}),r=this.getPubSub();r.publish(r.NAVIGATE,"search-page",{q:t,context:{referrer:"PaperSearchForm"}})},sendReferenceQuery:function(e){var r=t.Deferred(),o=this.getPubSub(),a=new n({target:s.REFERENCE+"/"+encodeURIComponent(e.reference),query:new i({}),options:{type:"GET",headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},done:function(e){return r.resolve(e)},fail:function(){return r.reject.apply(r,arguments)},always:function(){return r.always()}}});return o.publish(o.EXECUTE_REQUEST,a),r.promise()},onShow:function(){this.view.triggerMethod("show")}})});