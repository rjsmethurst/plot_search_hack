define(["underscore","jquery","js/components/api_query","js/components/api_targets","filesaver"],function(t,e,r,n){var o={SET_TAB:"SET_TAB",SET_QUERY:"SET_QUERY",SET_FORMAT:"SET_FORMAT",SET_FORMATS:"SET_FORMATS",SET_CUSTOM_FORMAT:"SET_CUSTOM_FORMAT",SET_PROGRESS:"SET_PROGRESS",SET_COUNT:"SET_COUNT",SET_IGNORE:"SET_IGNORE",SET_HAS_ERROR:"SET_HAS_ERROR",SET_ERROR_MSG:"SET_ERROR_MSG",SET_MAX_COUNT:"SET_MAX_COUNT",SET_TOTAL_RECS:"SET_TOTAL_RECS",SET_SHOW_CLOSER:"SET_SHOW_CLOSER",SET_PAGE:"SET_PAGE",SET_SORT:"SET_SORT",SET_BATCH_SIZE:"SET_BATCH_SIZE",TAKE_SNAPSHOT:"TAKE_SNAPSHOT",RESET:"RESET",HARD_RESET:"HARD_RESET",REQUEST_IDS:"REQUEST_IDS",RECEIVE_IDS:"RECEIVE_IDS",REQUEST_EXPORT:"REQUEST_EXPORT",RECEIVE_EXPORT:"RECEIVE_EXPORT",REQUEST_FAILED:"REQUEST_FAILED",REQUEST_CANCELLED:"REQUEST_CANCELLED",SET_ORIGIN:"SET_ORIGIN",SET_CUSTOM_FORMATS:"SET_CUSTOM_FORMATS",SET_BIBTEX_KEY_FORMAT:"SET_BIBTEX_KEY_FORMAT",SET_BIBTEX_MAX_AUTHORS:"SET_BIBTEX_MAX_AUTHORS",SET_BIBTEX_ABS_KEY_FORMAT:"SET_BIBTEX_ABS_KEY_FORMAT",SET_BIBTEX_ABS_MAX_AUTHORS:"SET_BIBTEX_ABS_MAX_AUTHORS",SET_BIBTEX_AUTHOR_CUTOFF:"SET_BIBTEX_AUTHOR_CUTOFF",SET_BIBTEX_ABS_AUTHOR_CUTOFF:"SET_BIBTEX_ABS_AUTHOR_CUTOFF",SET_BIBTEX_JOURNAL_FORMAT:"SET_BIBTEX_JOURNAL_FORMAT",setTab:function(t){return{type:o.SET_TAB,tab:t}},setFormat:function(t){return{type:o.SET_FORMAT,format:t}},setFormats:function(t){return{type:o.SET_FORMATS,formats:t}},setCustomFormat:function(t){return{type:o.SET_CUSTOM_FORMAT,format:t}},setProgress:function(t){return{type:o.SET_PROGRESS,progress:t}},setTotalRecs:function(t){return{type:o.SET_TOTAL_RECS,totalRecs:t}},setShowCloser:function(t){return{type:o.SET_SHOW_CLOSER,showCloser:t}},requestIds:function(){return{type:o.REQUEST_IDS}},receiveIds:function(t){return{type:o.RECEIVE_IDS,ids:t}},requestExport:function(){return{type:o.REQUEST_EXPORT}},receiveExport:function(t){return{type:o.RECEIVE_EXPORT,exports:t}},setBatchSize:function(t){return{type:o.SET_BATCH_SIZE,batchSize:t}},setQuery:function(t){return{type:o.SET_QUERY,query:t}},setCount:function(t){return{type:o.SET_COUNT,count:t}},setMaxCount:function(t){return{type:o.SET_MAX_COUNT,maxCount:t}},cancelRequest:function(){return{type:o.REQUEST_CANCELLED}},setIgnore:function(t){return{type:o.SET_IGNORE,ignore:t}},setHasError:function(t){return{type:o.SET_HAS_ERROR,hasError:t}},setErrorMsg:function(t){return{type:o.SET_ERROR_MSG,errorMsg:t}},setPage:function(t){return{type:o.SET_PAGE,page:t}},setSort:function(t){return{type:o.SET_SORT,sort:t}},reset:function(){return{type:o.RESET}},hardReset:function(){return{type:o.HARD_RESET}},setOrigin:function(t){return{type:o.SET_ORIGIN,origin:t}},setCustomFormats:function(t){return{type:o.SET_CUSTOM_FORMATS,customFormats:t}},setBibtexMaxAuthors:function(t){return{type:o.SET_BIBTEX_MAX_AUTHORS,maxAuthors:t}},setBibtexKeyFormat:function(t){return{type:o.SET_BIBTEX_KEY_FORMAT,keyFormat:t}},setBibtexABSMaxAuthors:function(t){return{type:o.SET_BIBTEX_ABS_MAX_AUTHORS,maxAuthors:t}},setBibtexABSKeyFormat:function(t){return{type:o.SET_BIBTEX_ABS_KEY_FORMAT,keyFormat:t}},setBibtexAuthorCutoff:function(t){return{type:o.SET_BIBTEX_AUTHOR_CUTOFF,payload:t}},setBibtexABSAuthorCutoff:function(t){return{type:o.SET_BIBTEX_ABS_AUTHOR_CUTOFF,payload:t}},setBibtexJournalFormat:function(t){return{type:o.SET_BIBTEX_JOURNAL_FORMAT,payload:t}},requestFailed:function(){return function(t){t((0,o.setHasError)(!0)),t({type:"REQUEST_FAILED"})}},findAndSetFormat:function(e){return function(r,n){var E=n().formats,T=t.find(E,{value:e});r(o.setFormat(T||E[0]))}},fetchUsingQuery:function(){return function(e,n,E){var T=n(),u=T.exports,S=T.main,_=E.composeRequest,s=o.requestIds,a=o.receiveIds,i=o.requestFailed,R=o.setTotalRecs,c=o.setHasError,A=o.setSort,f=new r(S.query);f.set({rows:u.count<u.batchSize?u.count:u.batchSize,fl:"bibcode",start:u.maxCount-u.batchSize}),e(c(!1)),e(s());var O=_(f),p=E._executeApiRequest(O);return p.then(function(r){var n=t.map(r.get("response.docs"),"bibcode"),o=r.get("responseHeader.params.sort",!1,"date desc");e(a(n)),e(A(o)),e(R(r.get("response.numFound")))}),p.fail(function(){return e(i.apply(void 0,arguments))}),p}},fetchUsingIds:function(E){return function(T,u,S){var _=o.requestExport,s=o.receiveExport,a=o.requestFailed,i=o.setIgnore,R=o.setHasError,c=S.composeRequest,A=u(),f=A.format,O=A.exports;T(R(!1)),T(_());var p=O.count<O.batchSize?O.count:O.batchSize,B=O.maxCount-O.batchSize,m=E?O.ids.slice(B,B+p):t.take(O.ids,p),F=new r;if(F.set("bibcode",m),F.set("sort",O.sort),"custom"===f.value&&O.customFormatString.length>0)F.set("format",O.customFormatString);else{if("custom"===f.value&&O.customFormatString.length<=0)return e.Deferred().resolve().promise().then(function(){T(s(""))});"bibtex"===f.value?(O.bibtexKeyFormat&&F.set("keyformat",O.bibtexKeyFormat),F.set("maxauthor",+O.bibtexMaxAuthors),F.set("authorcutoff",+O.bibtexAuthorCutoff),F.set("journalformat",O.bibtexJournalFormat)):"bibtexabs"===f.value?(O.bibtexABSKeyFormat&&F.set("keyformat",O.bibtexABSKeyFormat),F.set("maxauthor",+O.bibtexABSMaxAuthors),F.set("authorcutoff",+O.bibtexABSAuthorCutoff),F.set("journalformat",O.bibtexJournalFormat)):"aastex"===f.value&&F.set("journalformat",O.bibtexJournalFormat)}var y=c(F);return y.set({target:n.EXPORT+f.value,options:{type:"POST",contentType:"application/json"}}),S._executeApiRequest(y).done(function(t){O.ignore||T(s(t.get("export"))),T(i(!1))}).fail(function(){return T(a.apply(void 0,arguments))})}},getNextBatch:function(){return function(t,e){var r=o.setMaxCount,n=o.setBatchSize,E=o.setCount,T=o.fetchUsingQuery,u=o.fetchUsingIds,S=e().exports,_=S.maxCount+S.batchSize;if(_>S.totalRecs){var s=S.totalRecs-S.maxCount,a=S.count<s?S.count:s;_=S.maxCount+s,t(n(s)),t(E(a))}t(r(_)),S.ids.length===S.totalRecs?t(u(!0)):t(T()).done(function(){return t(u())})}},takeSnapshot:function(){return function(e,r){var n=t.omit(r().exports,"snapshot");e({type:o.TAKE_SNAPSHOT,snapshot:n})}},closeComponent:function(){return function(t,e,r){t(o.hardReset()),r.closeWidget()}},downloadFile:function(){return function(t,e){var r=e(),n=new Blob([r.exports.output],{type:"text/plain;charset=utf-8"});saveAs(n,"export-".concat(r.format.value,".").concat(r.format.ext),!0)}}};return o});